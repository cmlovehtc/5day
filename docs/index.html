<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>台指/小台/微型台指：前四日平均</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body class="bg-slate-950 text-slate-100">
  <main class="max-w-5xl mx-auto px-4 sm:px-5 py-5 md:py-8">
    <header class="space-y-4">
      <div class="flex flex-col gap-2">
        <h1 class="text-xl sm:text-2xl md:text-3xl font-semibold tracking-tight leading-snug">
          收盤價/最後成交價 & 前四日平均
        </h1>
        <p class="text-slate-300 text-sm sm:text-base">
          先顯示快取（秒開），進來後會自動抓一次最新資料；按「更新」可手動刷新。
        </p>
      </div>

      <!-- controls: mobile-friendly -->
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3 items-center">
        <select id="symbol" class="col-span-2 sm:col-span-1 bg-slate-900 border border-slate-700 rounded-xl px-3 py-3 text-base">
          <option value="TX" selected>TX（台指期貨）</option>
          <option value="MTX">MTX（小台）</option>
          <option value="TMF">TMF（微型臺指）</option>
        </select>

        <select id="marketCode" class="bg-slate-900 border border-slate-700 rounded-xl px-3 py-3 text-base">
          <option value="0" selected>一般</option>
          <option value="1">盤後</option>
        </select>

        <button id="refresh"
          class="bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700 rounded-xl px-4 py-3 font-semibold text-base">
          更新
        </button>
      </div>
    </header>

    <!-- cards -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mt-5 sm:mt-6">
      <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
        <div class="text-slate-300 text-sm">最新交易日收盤價（最後成交價）</div>
        <div id="closeToday" class="text-2xl font-semibold mt-2">—</div>
        <div id="closeMeta" class="text-xs text-slate-400 mt-2 break-words">—</div>
      </div>

      <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
        <div class="text-slate-300 text-sm">前 4 交易日平均（不含今天）</div>
        <div id="avgPrev4" class="text-2xl font-semibold mt-2">—</div>
        <div id="avgPrev4Meta" class="text-xs text-slate-400 mt-2 break-words">—</div>
      </div>

      <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
        <div class="text-slate-300 text-sm">預測下一交易日：前四日平均</div>
        <div id="avgNext4" class="text-2xl font-semibold mt-2">—</div>
        <div id="avgNext4Meta" class="text-xs text-slate-400 mt-2 break-words">—</div>
      </div>

      <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
        <div class="text-slate-300 text-sm">今天 -（不含今天的前四日平均）</div>
        <div id="diff" class="text-2xl font-semibold mt-2">—</div>
        <div id="diffMeta" class="text-xs text-slate-400 mt-2 break-words">—</div>
      </div>
    </section>

    <!-- chart -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 mt-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
        <div>
          <div class="text-slate-200 font-medium">圖表</div>
          <div id="status" class="text-xs text-slate-400 mt-1">—</div>
        </div>
        <div class="text-xs text-slate-400">平均線：每個點取它前 4 個交易日（不含當天）</div>
      </div>

      <div class="mt-4 h-[300px] sm:h-[340px]">
        <canvas id="chart"></canvas>
      </div>
    </section>

    <div id="toast" class="fixed bottom-5 left-1/2 -translate-x-1/2 hidden
      bg-slate-900 border border-slate-700 text-slate-100 px-4 py-2 rounded-xl shadow-lg text-sm"></div>
  </main>

  <script>
    // ✅ 你的 Vercel 網址（後端 API）
    const API_BASE = "https://5day.vercel.app";

    let chart;

    const CACHE_VERSION = "v2"; // 換版避免舊快取格式干擾
    const CACHE_KEY = `tx_cache_${CACHE_VERSION}`;
    const CACHE_MAX_AGE_MS = 7 * 24 * 60 * 60 * 1000;

    function toast(msg) {
      const t = document.getElementById("toast");
      t.textContent = msg;
      t.classList.remove("hidden");
      clearTimeout(toast._timer);
      toast._timer = setTimeout(() => t.classList.add("hidden"), 2200);
    }

    function fmt(n) {
      if (n == null || Number.isNaN(n)) return "—";
      return new Intl.NumberFormat("zh-TW", { maximumFractionDigits: 2 }).format(n);
    }

    function getTaipeiHM() {
      const parts = new Intl.DateTimeFormat("zh-TW", {
        timeZone: "Asia/Taipei",
        hour12: false,
        hour: "2-digit",
        minute: "2-digit"
      }).formatToParts(new Date());

      const hh = Number(parts.find(p => p.type === "hour")?.value ?? "0");
      const mm = Number(parts.find(p => p.type === "minute")?.value ?? "0");
      return { hh, mm };
    }

    function isAfterClose1345() {
      const { hh, mm } = getTaipeiHM();
      return (hh > 13) || (hh === 13 && mm >= 45);
    }

    // dataNewestFirst[0] = 最新(C0)
    // avgLine[i] = average of closes at (i+1..i+4)
    function buildPrev4AvgLine(dataNewestFirst) {
      const closes = dataNewestFirst.map(d => d.close);
      return closes.map((_, i) => {
        if (i + 4 >= closes.length) return null;
        const slice = closes.slice(i + 1, i + 5);
        const avg = slice.reduce((a, b) => a + b, 0) / 4;
        return Number(avg.toFixed(2));
      });
    }

    function cacheKeyFor(symbol, marketCode) {
      return `${symbol}_${marketCode}`;
    }

    function loadCacheMap() {
      try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return {};
        const parsed = JSON.parse(raw);
        return (parsed && typeof parsed === "object") ? parsed : {};
      } catch {
        return {};
      }
    }

    function saveCacheMap(map) {
      try { localStorage.setItem(CACHE_KEY, JSON.stringify(map)); } catch {}
    }

    function getCached(symbol, marketCode) {
      const map = loadCacheMap();
      const key = cacheKeyFor(symbol, marketCode);
      const entry = map[key];
      if (!entry) return null;

      if (!entry.savedAt || (Date.now() - entry.savedAt > CACHE_MAX_AGE_MS)) {
        delete map[key];
        saveCacheMap(map);
        return null;
      }
      return entry.payload || null;
    }

    function setCached(symbol, marketCode, payload) {
      const map = loadCacheMap();
      const key = cacheKeyFor(symbol, marketCode);
      map[key] = { savedAt: Date.now(), payload };
      saveCacheMap(map);
    }

    function render(json, { fromCache = false } = {}) {
      const status = document.getElementById("status");
      const data = json?.data || [];
      if (!data.length) {
        status.textContent = "沒有資料可顯示。";
        return;
      }

      const today = data[0];
      document.getElementById("closeToday").textContent = fmt(today.close);
      document.getElementById("closeMeta").textContent =
        `日期：${today.date}｜合約月：${today.contractMonth}｜成交量(挑主力)：${fmt(today.volume)}`;

      const avgPrev4 = json.avgPrev4;
      document.getElementById("avgPrev4").textContent = avgPrev4 != null ? fmt(avgPrev4) : "資料不足";
      document.getElementById("avgPrev4Meta").textContent =
        (data.length >= 5) ? `使用：${data[1].date}, ${data[2].date}, ${data[3].date}, ${data[4].date}` : `目前只有 ${data.length} 筆`;

      const avgNext4 = json.avgNext4;
      document.getElementById("avgNext4").textContent = avgNext4 != null ? fmt(avgNext4) : "資料不足";
      document.getElementById("avgNext4Meta").textContent =
        (data.length >= 4) ? `使用：${data[0].date}, ${data[1].date}, ${data[2].date}, ${data[3].date}` : `目前只有 ${data.length} 筆`;

      if (avgPrev4 != null) {
        const diff = Number((today.close - avgPrev4).toFixed(2));
        const pct = Number(((diff / avgPrev4) * 100).toFixed(2));
        document.getElementById("diff").textContent =
          `${diff >= 0 ? "+" : ""}${fmt(diff)}（${diff >= 0 ? "+" : ""}${fmt(pct)}%）`;
        document.getElementById("diffMeta").textContent =
          `(${fmt(today.close)} - ${fmt(avgPrev4)}) / ${fmt(avgPrev4)}`;
      } else {
        document.getElementById("diff").textContent = "—";
        document.getElementById("diffMeta").textContent = "—";
      }

      const tag = fromCache ? "（快取）" : "";
      status.textContent = `更新時間（台北）：${new Date(json.fetchedAtTaipei).toLocaleString("zh-TW")} ${tag}`;

      // chart (old -> new)
      const labels = [...data].reverse().map(d => d.date);
      const closes = [...data].reverse().map(d => d.close);
      const avgLine = buildPrev4AvgLine(data);
      const avgLineReversed = [...avgLine].reverse();

      const ctx = document.getElementById("chart");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "收盤價/最後成交價", data: closes, tension: 0.25, pointRadius: 2 },
            { label: "前四交易日平均（不含當天）", data: avgLineReversed, tension: 0.25, pointRadius: 2, spanGaps: true }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: "index", intersect: false },
          plugins: { legend: { labels: { color: "#e2e8f0" } } },
          scales: {
            x: { ticks: { color: "#94a3b8" }, grid: { color: "rgba(148,163,184,0.12)" } },
            y: { ticks: { color: "#94a3b8" }, grid: { color: "rgba(148,163,184,0.12)" } }
          }
        }
      });
    }

    async function fetchLatestAndRender({ silentToast = false } = {}) {
      const symbol = document.getElementById("symbol").value;
      const marketCode = document.getElementById("marketCode").value;
      const status = document.getElementById("status");

      if (!silentToast && !isAfterClose1345()) {
        toast("提醒：尚未收盤，這次顯示的是「最後成交價」（盤中會變動）。");
      }

      status.textContent = "抓資料中…";

      // ✅ 加上 _t 避免中間層快取；cache: 'no-store' 避免瀏覽器快取
      const url = `${API_BASE}/api/closes?symbol=${encodeURIComponent(symbol)}&days=30&marketCode=${encodeURIComponent(marketCode)}&_t=${Date.now()}`;
      const res = await fetch(url, { cache: "no-store" });
      const json = await res.json();

      if (!json?.data?.length) {
        status.textContent = "沒有抓到資料（API 無回應/非交易日/連線失敗）。";
        return;
      }

      setCached(symbol, marketCode, json);
      render(json, { fromCache: false });
    }

    function showCacheIfAny() {
      const symbol = document.getElementById("symbol").value;
      const marketCode = document.getElementById("marketCode").value;
      const cached = getCached(symbol, marketCode);
      if (cached) {
        render(cached, { fromCache: true });
        return true;
      }
      return false;
    }

    // 手動更新
    document.getElementById("refresh").addEventListener("click", () => {
      fetchLatestAndRender({ silentToast: false });
    });

    // 切換商品/時段：先顯示快取，然後立刻抓最新（這就是讓「別人進來也會更新」的關鍵）
    document.getElementById("symbol").addEventListener("change", () => {
      showCacheIfAny();
      fetchLatestAndRender({ silentToast: true });
    });

    document.getElementById("marketCode").addEventListener("change", () => {
      showCacheIfAny();
      fetchLatestAndRender({ silentToast: true });
    });

    // ✅ 進站流程：
    // 1) 有快取就先畫（秒開）
    // 2) 立刻自動抓最新覆蓋（所以別人不會一直卡舊快取）
    const hadCache = showCacheIfAny();
    if (!hadCache) {
      document.getElementById("status").textContent = "尚無快取，正在抓最新資料…";
    }
    fetchLatestAndRender({ silentToast: true });
  </script>
</body>
</html>
